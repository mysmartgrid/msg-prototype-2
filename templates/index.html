{{define "index"}}
{{template "head" "home"}}
<div class="container">
	<div class="row">
		{{if .Ws}}
			{{range $devname, $dev := (.User.Devices)}}
			{{range $sensorname, $_ := (.Sensors)}}
			{{with $name := printf "%v-%v" $devname $sensorname}}
			<div id="sdisp-{{$name}}" class="epoch category10" style="height: 200px;"></div>
			{{end}}
			{{end}}
			{{end}}
			<script>
				var wsEndpoint = "{{.Ws | js}}";

				var startTime = (+new Date()) / 1000;
				var charts = {};

				var setupChart = function(name) {
					return $('#sdisp-' + name).epoch({
						type: 'time.line',
						label: 'Plot',
						data: [
						{ label: "val", values: [{ time: startTime, y: 0 }] },
						],
						axes: ['left', 'right', 'bottom'],
						tickFormats: {
							left: function(d) {
								return d + " W";
							}
						},
						ticks: {
							time: 20,
						},
						historySize: 120,
						windowSize: 120
					});
				};

				{{range $devname, $dev := (.User.Devices)}}
				{{range $sensorname, $_ := (.Sensors)}}
				{{with $name := printf "%v-%v" $devname $sensorname}}
				charts[{{$name}}] = setupChart({{$name}});
				{{end}}
				{{end}}
				{{end}}

				if (window["WebSocket"]) {
					var ws = new WebSocket(wsEndpoint, ["msg/1/user"]);

					ws.onmessage = function(e) {
						var data = JSON.parse(e.data);
						if (data.cmd !== "update") {
							return;
						}

						data = data.args
						Object.getOwnPropertyNames(data).forEach(function (dev) {
							Object.getOwnPropertyNames(data[dev]).forEach(function (sens) {
								data[dev][sens].forEach(function (point) {
									charts[dev + "-" + sens].push([
										{ time: point[0] / 1000, y: point[1] || NaN }
									]);
								});
							});
						});
					};
				}
			</script>
		{{else}}
			<form action="/" method="POST">
				<p>
					<label for="user" {{alertIfMissing "user" .Missing}}>Display user</label>
					<input type="text" name="user" length="20" />
				</p>
				<input type="submit" value="Submit" />
			</form>
		{{end}}
	</div>
</div>
{{template "tail"}}
{{end}}
